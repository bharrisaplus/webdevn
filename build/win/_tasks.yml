# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: '3'

vars:
  BUILD_RESBIN: "{{.WIN_X64_BUILD_OUTPUT_DIR}}/{{.VERSION_NUM}}.res"


tasks:
  assemble-resources:
    aliases: [asre]
    vars:
      SRC_RC: "{{.BUILD_CONFIG_DIR}}/win/metadata/{{.VERSION_NUM}}.rc"
      BUILD_RC: "{{.WIN_X64_BUILD_OUTPUT_DIR}}/{{.VERSION_NUM}}.rc"
    cmds:
      - cp {{.SRC_RC}} {{.BUILD_RC}}
      - cp {{.ASSET_DIR}}/img/raster/icon.ico {{.WIN_X64_BUILD_OUTPUT_DIR}}
      - windres {{.BUILD_RC}} -O coff -o {{.BUILD_RESBIN}}

  rear-x64-debug:
    vars:
      BUILD_OUTPUT_DIR: "--outDir:{{.WIN_X64_BUILD_OUTPUT_DIR}}"
    cmds:
      - nim c {{.BUILD_OUTPUT_DIR}} $SOURCE_DIR/webdevn.nim

  rear-x64:
    vars:
      BUILD_OUTPUT_DIR: '--outDir:{{.WIN_X64_BUILD_OUTPUT_DIR}}'
      WIN_BUILD_NIMDEFINE_FLAGS: "{{.BUILD_NIMDEFINEFLAGS}} --passL:{{.BUILD_RESBIN}}"
    cmds:
      - task: assemble-resources
      - nim c {{.WIN_BUILD_NIMDEFINE_FLAGS}} {{.BUILD_OUTPUT_DIR}} $SOURCE_DIR/webdevn.nim

  wrap-x64:
    vars:
      BUILD_OUTPUT_FILE: '{{.WIN_X64_BUILD_OUTPUT_DIR}}/webdevn.exe'
      BUILD_OUTPUT_FILE_CHKSUM: '{{.BUILD_OUTPUT_FILE}}.sha256'
      BUILD_OUTPUT_ZIP: '{{.WIN_X64_BUILD_OUTPUT_DIR}}/webdevn_winx64-$VERSION_NUM.zip'
      BUILD_OUTPUT_ZIP_CHKSUM: '{{.BUILD_OUTPUT_ZIP}}.sha256'
    cmds:
      - task: rear-x64
      - shasum -a 256 {{.BUILD_OUTPUT_FILE}} | cut -d ' ' -f 1 > {{.BUILD_OUTPUT_FILE_CHKSUM}}
      - zip -j {{.BUILD_OUTPUT_ZIP}} {{.BUILD_OUTPUT_FILE}} {{.BUILD_OUTPUT_FILE_CHKSUM}}
      - shasum -a 256 {{.BUILD_OUTPUT_ZIP}} | cut -d ' ' -f 1 > {{.BUILD_OUTPUT_ZIP_CHKSUM}}

  sweep-x64:
    cmds:
      - rm -rf {{.WIN_X64_BUILD_OUTPUT_DIR}}/*.exe
      - rm -rf {{.WIN_X64_BUILD_OUTPUT_DIR}}/*.zip
      - rm -rf {{.WIN_X64_BUILD_OUTPUT_DIR}}/*.sha256
      - rm -rf {{.WIN_X64_BUILD_OUTPUT_DIR}}/*.rc
      - rm -rf {{.WIN_X64_BUILD_OUTPUT_DIR}}/*.ico
      - rm -rf {{.WIN_X64_BUILD_OUTPUT_DIR}}/*.res
